# 计算机网络体系结构

## 概述

### 组成部分
  - 软件
  - 硬件
  - 协议
### 分类
  - 广域网WAN
  - 城域网MAN
  - 局域网LAN
  - 个域网PAN
### 交换技术
  - 电路交换
  - 报文交换
  - 分组交换（把报文交换切块）

#### 分组时延=发送时延+传播时延+处理时延+排队时延

## 体系

### 分层结构
  - PDU协议数据单元
  - PCI协议控制信息
  - SDU服务数据单元

#### `n-SDU` = `(n+1)-PDU`
#### `n-PDU` = `n-PCI`+`n-SDU`

### OSI七层
  - 应用层
  - 表示层
    - 数据格式变换（二进制->图片）
    - 数据加解密
    - 数据压缩解压
  - 会话层
    - 管理会话
    - 同步
  - 传输层（端到端通信）
    - （不）可靠传输
    - 差错控制
    - 流量控制
    - 复用分用
  - 网络层（传输单位数据报）
    - 路由选择
    - 差错控制
    - 流量控制
    - 拥塞控制
  - 链路层（传输单位帧）
    - 成帧
    - 差错控制
    - 流量控制
    - 访问控制
  - 物理层（传输单位比特）

#### 上三层：资源子网、下三层：通信子网

### TCP/IP四层
  - 应用层
  - 传输层
  - 网络层
  - 网络接口层

### 五层
  - 应用层: FTP SMTP
  - 传输层: TCP UDP
  - 网络层: IP ICMP OSPF
  - 链路层: Ethernet PPP (成帧)
  - 物理层: bit

# 物理层
## 接口特性
  - 机械特性：接口大小形状
  - 电气特性：电压范围
  - 功能特性：电平意义
  - 规程特性：时序
## 通信基础
### 基本概念
####
  - 同步传输
  - 异步传输
#### 传输方式
  - 串行传输
  - 并行传输
#### 通信方式
  - 单工通信 需要1条信道
  - 半双工通信 需要2条信道（信道有方向，是矢量）
  - 全双工通信 需要2条信道

### 公式
  - 码元速率：R<sub>b</sub> = 1/T 只与码元长度T有关系 
  - 奈氏准则：码元传输速率<=2W Baud，W为带宽，单位Hz。1Baud = log_2 V b/s
  - 香农定理：数据传输速率<=Wlog_2(1+S/N) b/s，W为带宽，单位Hz。信噪比（dB） = 10log_10(S/N)
### 编码与调制
  - 非归零编码(NRZ)：高1低0
  - 归零编码：高低1低低0
  - 反向不归零编码(NRZI)：翻转0不翻转1
  - 曼彻斯特编码：前低后高1前高后低0（数据传输速率为调制速率1/2）
  - 差分曼彻斯特编码：翻转0不翻转1
  - 4B/5B编码：效率80%

### 数据交换方式
  - 电路交换
  - 存储转发方式
    - 报文交换
    - 分组交换（报文交换切块）
      - 数据报方式（随机路由）
      - 虚电路方式（虚拟链路）

## 传输

### 介质
  - 非导向型介质
  - 导向型介质

### 设备
  - 中继器：信号再生与还原(信号放大器、光猫)
    - 5-4-3规则：设备--中继器---中继器---设备---中继器---中继器---设备
  - 集线器：多口广播中继器，不隔离冲突域，不隔离广播域
    - 平分带宽

# 链路层
  - 功能
    - 功能1：将网络层数据可靠的交由相邻节点
      - 无确认无连接
      - 有确认无连接
      - 有确认有连接
    - 功能2：链路管理：建立、维持、释放（面向连接）
    - 功能3：组帧：加帧首帧尾定界，数据部分长度<=MTU
      - 字符计数法
      - 字符填充法：SOH、ESC、EOT
      - 零比特填充法√：5 “1” 1 “0”，5个1插入0，首尾01111110定界符
      - 违规编码法√：曼彻斯特编码中：高高、低低
    - 功能4：差错控制
      - 分类
        - 位错：0<=>1
        - 帧错：丢、重、乱
      - 检错
        - 奇偶校验码
          - 奇校验：使1为奇数个
          - 偶校验：使1为偶数个
        - 循环冗余码CRC
          - 数据加n-1个0,除n位多项式取余，数据+余数(FCS)
      - 纠错
        - 海明码：检测d位错需要海明距离d+1，纠正d位错需要海明距离2d+1
        - 海明不等式：数据m位，校验码r位，2^r>=m+r+1
        - 校验码放2^n位置上，通配符偶（奇）校验
    - 功能5：流量控制
      - 链路层流量控制点对点：接收端受不下不回复确认
      - 网络层流量控制端到端：接受端给发送端窗口公告
      - 分类
        - 停止等待协议:发窗=1，收窗=1
          - 协议
            - 1.保留上帧副本，未收到确认则重传
            - 2.收方：收到重传帧，丢弃并重发ACK
            - 3.发方：收到重传ACK，直接丢弃
          - 优缺：简单；信道利用率低
          - 信道利用率：L/C/T（L：比特数，C：数据传输率，T：从发到收ack时间）
          - 信道吞吐率：信道利用率*发送速率
        - 滑动窗口协议
          - 回退N协议(GBN):发窗>1，收窗=1
            - 用n个bit编号帧，则窗口大小W<=2^n-1
          - 选择重传协议(SR):发窗>1，收窗>1
            - 用n个bit编号帧，则窗口大小W<=2^(n-1)
  - 信道访问控制
    - 静态划分信道
      - 频分多路FDM
      - 时分多路TDM
      - 波分多路WDM(光的频分多路)
      - 码分多路CDM
    - 动态划分信道
      - 随机访问控制
        - ALOHA：想发就发，冲突重发
        - CSMA
          - 1-坚持CSMA：一直监听，空闲则发，冲突则等随机时常继续监听
          - 非坚持CSMA：忙则等随机时间后再检测，空闲则发
          - p-坚持CMSA：一直监听，空闲则以p概率发，冲突则等下个时间槽
        - CSMA/CD（有线以太网）
          - 发中检测，冲突则停
          - 二进制退避重传：k=min(重传次数, 10)，0~2^k-1随机取r，等待2τr时间
          - 重传失败16次放弃
          - 最小帧长 = 发送速率 * 传播时延 * 2 = 发送速率 * 2τ （以太网64B）
        - CSMA/CA（无线局域网）
          - 忙则等待
          - 闲则发RTS（发地址+收地址+发时长）
          - 收端响应CTS，发端收到开始发，预约信道，告知邻站占用时长
          - 收端CRC校验相应ACK
          - 发端二进制退避重传
      - 轮询访问控制
        - 轮询协议：主节点轮流邀请发送
        - 令牌传递协议：令牌标志位置1，附数据。收端提取
  - 局域网
    - 要素：网络拓扑、传播介质、访问控制协议
    - IEEE标准
      - 802.3:以太网CSMA/CD
      - 802.5:令牌环网
      - 802.8:光纤联网
      - 802.11:无线局域网
    - 以太网：无连接（不握手），不可靠（差错丢弃不确认）
      - 物理上星型，逻辑上总线型，每段双绞线最长100m
      - 曼彻斯特编码，CSMA/CD
      - MAC帧格式：目的地址(6)+源地址(6)+v2(2)+数据(46~1500)+FCS(4)
    - 无线局域网
      - MAC帧格式：帧控+生存周期+收端(RA)+发端(TA)+目的地址(DA)+序控+源地址(SA)
    - 虚拟局域网VLAN
      - 单交换机：端口-VLAN_id映射
      - 多交换机：交换机加VLAN_id tag
    - 广域网
      - PPP协议
  - 设备
    - 网桥：双口，MAC地址-端口映射表，定向转发
    - 以太网交换机：多口网桥，独占媒体带宽，隔离冲突域，不隔离广播域

# 网络层
## 概述和功能
  - 传输单位：数据报
  - 功能
    - 路由选择与转发
      - 转发（路由器内部）
      - 路由（路由器之间）
    - 异构网络互联
    - 拥塞控制
  - 数据平面：转发
  - 控制平面：选择
    - 传统方法（每路由器法）：路由选择算法运行在每个路由器
    - SDN方法：高性能服务器计算路由表并下发至路由器
      - 控制程序、北向API
      - 网络范围状态管理层
      - 通信层、南向API（openFlow协议与路由器交流）
## IP数据格式
![](https://jason-01.oss-cn-hangzhou.aliyuncs.com/public/image/markdown/image-20200713105453317.png)
  - 首部长度：乘4B
  - 标识：SSRC
  - 标志：中间位DF=1-禁止分片、最低位MF=1-非最后一片
  - 片偏移：乘8B
  - 生存时间TTL：过路由器-1
  - 协议：ICMP-1、IGMP-2、TCP-6、UDP-17、IPv6-41
## IPv4
  - A类(1~126)：  1B网络号，0
  - B类(128~191)：2B网络号，10
  - C类(192~223)：3B网络号，110
  - D类(224~239)：多播地址，1110
  - E类(240~255)：保留，1111
## IPv6
  - 基本首部固定40B
  - 过渡方案
    - 双栈协议：同时支持
    - 隧道技术：IPv4包v6
## 子网划分
  - 两级IP：网络号+主机号
  - 三级IP：网络号+子网号+主机号
  - 网络号+子网号=三级IP&子网掩码
  - CIDR
    - 构成超网
    - 最长前缀匹配

## 网络协议
### ARP
  - 与自己同网段
    - 广播ARP请求：|FF-FF-FF-FF-FF|源MAC|目的IP|源IP|
      - 响应：|目的MAC|目的IP|
  - 不与自己同网段
    - 获取网关MAC
    - |网关MAC|源MAC|目的IP|源IP|
### DHCP协议
  - 应用层协议、C/S模式、广播、UDP

### ICMP协议
  - 差错报告：ICMP差错不发、组播不发、特殊地址不发、分段仅第一段发
  - 网络探寻：ping traceroute

## 路由算法
  - 静态路由算法
  - 动态路由算法
    - AS内部网关协议IGP
      - RIP(应用层协议，UDP)
        - 路由表：目的网络-距离-下一跳
        - 仅和相邻路由器交换路由表/30s，180s无应答距离置16
        - 一条RIP报文最多传25条记录
      - OSPF(网络层协议，IP数据报)
        - 相邻路由器洪泛法发送链路状态（相邻路由器、代价）至所有路由器/链路变化 LSU
        - 邻站返回LSACK
        - 每个路由器用dijkstra算最短路径
    - AS外部网关协议EGP
      - BGP(应用层协议，TCP)
        - 相邻BGP发言人交换AS网络向量信息/链路变化
## IP组播
  - 数据在尽可能近的路由器进行复制，UDP
  - 组播MAC：01-00-5E+0+组播IP后23位
  - 因为组播IP还有5位没用，所以需要在应用层再过滤一下
  - IGMP协议：告知路由器是否有主机加入/退出组播
  - 组播路由选择协议：找到源主机为根的组播树

## 移动IP
  - 获取外部代理地址-通过外部代理向归属代理注册-归属代理绑定移动节点和外部代理并返回ACK

## 网络层设备
  - 路由器
    - 路由选择
    - 分组转发

# 传输层

## 概述
  - 进程间通信
  - 复用分用
  - 差错检测
  - 0~1023熟知端口号、1024~49151登记端口号、49152~65535动态运行时端口号

## TCP协议
  - 首部20B
  - 三次握手
    - 客户端->服务端：SYN=1，seq=x
    - 服务端->客户端：SYN=1，ACK=1，seq=y，ack=x+1
    - 客户端->服务端：ACK=1，seq=x+1，ack=y+1
  - 四次挥手
    - 客户端->服务端：FIN=1，seq=u
    - 服务端->客户端：ACK=1，seq=v，ack=u+1
    - 服务端->客户端：FIN=1，ACK=1，seq=w，ack=u+1
    - 客户端->服务端：ACK=1，seq=u+1，ack=w+1
  - 慢开始&拥塞避免
  - 快重传&快恢复
## UDP协议
  - 首部8B：2B源端口+2B目的端口+2B长度+2B校验和

# 应用层
  - DNS
    - 递归查询：靠别人
    - 迭代查询：靠自己
  - FTP
    - 控制端口21
    - 主动模式
      - 传输端口20
    - 被动模式
      - 传输端口协商
  - SMTP POP3 IMAP
  - HTTP
    - 非持久连接
    - 持久连接